// Generated by CoffeeScript 1.9.3
(function() {
  var Ajax, Alert, clickcard, divbuttom, divtop, loadPhoto, log, root, scroll_to_load,
    slice = [].slice;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.run = function() {};

  log = function() {
    var i, k, len, results;
    results = [];
    for (k = 0, len = arguments.length; k < len; k++) {
      i = arguments[k];
      results.push(console.log(i));
    }
    return results;
  };

  Alert = function() {
    var arg;
    arg = 1 <= arguments.length ? slice.call(arguments, 0) : [];
    return alert(arg.join(''));
  };

  Ajax = function(filename) {
    var ajaxloader;
    ajaxloader = new XMLHttpRequest();
    ajaxloader.open("GET", "Ajax/photos.json", true);
    ajaxloader.onreadystatechange = function() {
      if (ajaxloader.readyState === 4 && ajaxloader.status === 200) {
        root.re = JSON.parse(ajaxloader.responseText);
        
			var count = 0;
			for (var k in re) {
			    if (re.hasOwnProperty(k)) {
			       ++count;
			    }
			}
			;
        root.re.length = count;
        loadPhoto();
        loadPhoto();
        loadPhoto();
        loadPhoto();
        if ($(window).height() === $(document).height()) {
          return loadPhoto();
        }
      }
    };
    return ajaxloader.send();
  };

  loadPhoto = function() {
    var col, colAppendPhoto, k, len, loadAddiction, loaded, ref;
    loaded = function() {
      $('.card').css("display", "inline-block");
      $("body").css("overflow", "auto");
      return loadAddiction();
    };
    colAppendPhoto = function(col) {
      var card, cardcontent, content, foo, img, imgsrc;
      foo = false;
      if (id >= re.length - 1 && foo === false) {
        foo = true;
        Alert("loaded all");
        return;
      }
      log("load");
      imgsrc = re[id]['tumb'];
      cardcontent = "";
      img = $(document.createElement('div')).addClass('image').append($('<img />').attr('src', imgsrc)).attr('alt', 'id');
      img.bind('load', onload);
      if (cardcontent === !"") {
        content = $(document.createElement('div')).addClass('cardcontent').append($('<p />')).append(cardcontent);
      } else {
        content = null;
      }
      card = $(document.createElement('div')).addClass('card').append(img).append(content).attr('id', 'img_' + id).bind("click", clickcard);
      card.css("display", "none");
      card.appendTo(col);
      return id += 1;
    };
    loadAddiction = function() {
      var Ncol, buttom_of_short, i, j, k, l, lastCards, loadI, ref, ref1, results, top_of_long;
      Ncol = $('.column').length;
      lastCards = $('.column .card:last-child');
      if (lastCards === []) {
        return;
      }
      results = [];
      for (i = k = 0, ref = Ncol - 1; 0 <= ref ? k <= ref : k >= ref; i = 0 <= ref ? ++k : --k) {
        loadI = false;
        for (j = l = 0, ref1 = Ncol - 1; 0 <= ref1 ? l <= ref1 : l >= ref1; j = 0 <= ref1 ? ++l : --l) {
          if (i !== j) {
            buttom_of_short = divbuttom(lastCards[i]);
            top_of_long = divtop(lastCards[j]);
            if (divbuttom(lastCards[i]) < divtop(lastCards[j])) {
              loadI = true;
            }
          }
        }
        if (loadI) {
          results.push(colAppendPhoto(lastCards[i].parentNode));
        } else {
          results.push(void 0);
        }
      }
      return results;
    };
    log("append columns");
    $("body").css("overflow", "hidden");
    ref = $('.column');
    for (k = 0, len = ref.length; k < len; k++) {
      col = ref[k];
      colAppendPhoto(col);
    }
    return $('.columns').attr('onload', loaded);
  };

  clickcard = function() {
    var POP, clickloadMore, copyCardWithImage, id, loadCard, loadingGIF, newComment, newCommentBox, newComments, newLoadMore, onloadPOP;
    copyCardWithImage = function(id) {
      var card, img;
      card = $("#" + id).clone();
      log(card);
      img = card.find('img').attr('src', card.find('img').attr('src').replace("tumbnails", "")).bind('load', onloadPOP);
      return card;
    };
    newCommentBox = function() {
      return $(document.createElement('div')).addClass('commentBox');
    };
    newComments = function() {
      var comments;
      return comments = $(document.createElement('div')).attr('id', 'comments');
    };
    newComment = function(author, speach) {
      var a, comment, s;
      comment = $(document.createElement('div')).addClass('comment');
      a = $(document.createElement('h1')).append(author);
      s = $(document.createElement('p')).append(speach);
      return comment.append(a).append(s);
    };
    newLoadMore = function() {
      var load;
      load = $(document.createElement('button')).attr('id', 'LoadMore').append("[获取更多]");
      return load;
    };
    onloadPOP = function() {
      log("onload");
      log($('#POP').find('.card'));
      return $('#POP').find('.card').css('opacity', '1');
    };
    clickloadMore = function(event) {
      var comment;
      event.stopPropagation();
      comment = newComment('kehao', "已在现有的浏览器会话中创建新的窗口。已在现有的浏览器会话中创建新的窗口。");
      return $('.commentBox').append(comment);
    };
    loadCard = function(id) {
      var card, comment, commentBox, comments, loadMore;
      card = copyCardWithImage(id);
      comment = newComment('kehao', "已在现有的浏览器会话中创建新的窗口。已在现有的浏览器会话中创建新的窗口。");
      commentBox = newCommentBox().append(comment).append(comment);
      loadMore = newLoadMore();
      comments = newComments().append(commentBox);
      comments.append(loadMore);
      card.append(comments);
      POP.append(card);
      document.getElementById('POP').addEventListener("click", clickPOP);
      document.getElementById('LoadMore').addEventListener("click", clickloadMore);
      return document.getElementById('POP').onload = onloadPOP;
    };
    loadingGIF = function() {
      var gif, lo;
      lo = document.createElement('div');
      $(lo).addClass('loadingGIF');
      gif = $(document.createElement('img')).attr('src', 'Images/loading.gif');
      $(lo).append(gif).append('<p>正在努力加载中...</p>');
      return $('#POP').append(lo);
    };
    id = $(this).attr('id');
    POP = $(document.createElement('div')).attr('id', 'POP').appendTo($('body'));
    loadingGIF();
    return loadCard(id);
  };

  root.clickPOP = function() {
    return $(document.getElementById('POP')).remove();
  };

  scroll_to_load = function() {
    if ($(window).scrollTop() + $(window).height() > $(document).height() - 50) {
      return loadPhoto();
    }
  };

  divbuttom = function(div) {
    if (div === void 0) {
      return 100;
    } else {
      return $(div).position().top + $(div).height();
    }
  };

  divtop = function(div) {
    if (div === void 0) {
      return 0;
    } else {
      return $(div).position().top;
    }
  };

  window.id = 0;

  window.onkeydown = function() {
    return loadPhoto();
  };

  window.onresize = function() {};

  window.onload = function() {
    return Ajax("Ajax/photos.json");
  };

  window.onscroll = function() {
    return scroll_to_load();
  };

}).call(this);
